<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phonics Flying: Ace English x ç¿Šè¯æ•™è‚²</title>
    <style>
        /* å¼•å…¥å¯æ„›åœ“æ½¤çš„å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap');

        body {
            margin: 0;
            /* å¯æ„›å¡é€šå¤©ç©ºèƒŒæ™¯ */
            background-color: #AEEEEE;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 20%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 20%),
                linear-gradient(to bottom, #AEEEEE 0%, #E0FFFF 100%);
            overflow: hidden;
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            user-select: none;
            touch-action: none;
        }
        
        #video {
            position: absolute; top: 0; left: 0; opacity: 0; z-index: -1; width: 1px; height: 1px; pointer-events: none;
        }

        canvas {
            position: absolute; top: 0; left: 0; transform: scaleX(-1);
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }
        
        /* ç³–æœé¢¨æ ¼åˆ†æ•¸æ¬„ */
        .hud-bar {
            margin-top: 20px;
            background: linear-gradient(to bottom, #FFD1DC, #FFB6C1); /* ç²‰å«©æ¼¸å±¤ */
            padding: 12px 40px;
            border-radius: 60px;
            border: 5px solid #fff;
            box-shadow: 0 8px 0px rgba(0,0,0,0.1), inset 0 5px 10px rgba(255,255,255,0.5);
            display: flex; gap: 40px;
            color: #FF6B81; font-size: 26px; font-weight: 700;
            text-shadow: 2px 2px 0px #fff;
            z-index: 10;
        }

        /* éŠæˆ²ä¸­åº•éƒ¨çš„è£½ä½œå–®ä½æ–‡å­— */
        .footer-credit {
            margin-bottom: 20px; font-size: 18px; color: #FF6B81; font-weight: 700;
            background: rgba(255,255,255,0.8); padding: 8px 25px; border-radius: 30px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            text-align: center;
        }

        #speaker-icon {
            position: absolute; top: 15%; left: 50%; transform: translate(-50%, -50%);
            font-size: 90px; opacity: 0.9; transition: 0.2s;
            filter: drop-shadow(0 5px 0 #FFB6C1) drop-shadow(0 0 15px #fff);
            z-index: 5;
        }
        .speaking { animation: wobble-speaker 0.5s infinite alternate; }
        @keyframes wobble-speaker { from { transform: translate(-50%, -50%) rotate(-5deg) scale(1.1); } to { transform: translate(-50%, -50%) rotate(5deg) scale(1.3); } }

        /* é–‹å§‹ç•«é¢ - å¯æ„›é¢¨ */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            background-image: radial-gradient(#FFB6C1 10%, transparent 10%), radial-gradient(#AEEEEE 10%, transparent 10%);
            background-size: 30px 30px; background-position: 0 0, 15px 15px;
            z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; text-align: center;
        }

        h1 {
            font-size: 50px; margin-bottom: 10px; color: #FF6B81;
            text-shadow: 4px 4px 0px #fff, 6px 6px 0px #FFB6C1;
            font-weight: 900;
        }

        /* Ace English æ¨™é¡Œæ¨£å¼ */
        .producer-title {
            font-size: 28px; color: #fff; margin-bottom: 10px; font-weight: bold;
            background: #87CEEB; padding: 10px 40px; border-radius: 50px;
            border: 4px solid #fff; box-shadow: 0 5px 0 rgba(0,0,0,0.1);
            text-align: center;
            letter-spacing: 1px;
        }

        /* ç¿Šè¯æ•™è‚² å‰¯æ¨™é¡Œæ¨£å¼ */
        .sub-producer-title {
            font-size: 20px; color: #888; margin-bottom: 30px;
            font-weight: 700; letter-spacing: 2px;
        }

        /* æ£‰èŠ±ç³–æŒ‰éˆ• */
        button {
            margin-top: 20px; padding: 20px 70px; font-size: 32px; font-family: 'Fredoka', sans-serif; font-weight: 900;
            background: linear-gradient(to bottom, #AEEEEE, #87CEEB);
            color: white; border: 5px solid #fff; border-radius: 60px;
            cursor: pointer; box-shadow: 0 10px 0 #6FB7D6, 0 15px 20px rgba(0,0,0,0.2);
            transition: 0.1s; text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(8px); box-shadow: 0 2px 0 #6FB7D6, 0 5px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-bar">
            <div id="score-display">Coins: 0</div>
            <div id="streak-display">Streak: 0</div>
        </div>
        
        <div id="speaker-icon">ğŸ”Š</div>

        <div class="footer-credit">
            ç¿Šè¯æ•™è‚²AIæ•¸ä½æ•™æ
        </div>
    </div>

    <div id="start-screen">
        <h1>Phonics Adventure</h1>
        
        <div class="producer-title">
            Ace English
        </div>
        
        <div class="sub-producer-title">
            ç¿Šè¯æ•™è‚²AIæ•¸ä½æ•™æ
        </div>

        <div style="margin: 15px; background: #fff; padding: 20px; border-radius: 30px; border: 4px solid #FFB6C1; color: #666; font-size: 20px; font-weight: 600;">
            <p>ğŸ§ è«‹æ‰“é–‹è²éŸ³</p>
            <p>ğŸˆ ç”¨ã€Œæ˜Ÿæ˜Ÿæ£’ã€æˆ³ç ´æ­£ç¢ºçš„å–®å­—ï¼</p>
        </div>
        <button id="startBtn">PLAY!</button>
        <p id="loading-text" style="margin-top: 20px; font-size: 16px; color: #888; font-weight: bold;">è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹å†’éšª...</p>
    </div>

    <video id="video" playsinline></video>
    <canvas id="output"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output');
        const ctx = canvasElement.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('startBtn');
        const speakerIcon = document.getElementById('speaker-icon');
        const scoreDisplay = document.getElementById('score-display');
        const streakDisplay = document.getElementById('streak-display');
        const loadingText = document.getElementById('loading-text');

        let width, height;
        let gameActive = false;
        let score = 0;
        let streak = 0;
        let audioCtx;

        // --- ğŸ“š Minimal Pairs å®Œæ•´é¡Œåº« ---
        const wordPairs = [
            // ğŸŸ¢ çŸ­æ¯éŸ³ vs çŸ­æ¯éŸ³
            ["Bit", "Bet"], ["Bit", "Bat"], ["Bet", "Bat"], 
            ["Sit", "Set"], ["Sit", "Sat"], 
            ["Pen", "Pan"], ["Men", "Man"], ["Pin", "Pen"],
            ["Bed", "Bad"], ["Lip", "Lap"],

            // ğŸ”µ çŸ­æ¯éŸ³ vs çŸ­æ¯éŸ³ï¼ˆä¸åŒé«˜åº¦ï¼‰
            ["Cut", "Cat"], ["Cup", "Cap"], 
            ["Luck", "Lock"], ["Look", "Lock"], 
            ["Bus", "Boss"], ["Duck", "Dock"], 
            ["Full", "Fool"], ["Pull", "Pool"], ["Foot", "Food"],
            ["Ship", "Sheep"], 

            // ğŸŸ¡ çŸ­æ¯éŸ³ vs é•·æ¯éŸ³
            ["Bit", "Beat"], ["Sit", "Seat"], ["Hit", "Heat"], 
            ["Fill", "Feel"], ["Bin", "Bean"], 
            ["Hat", "Hate"], ["Cap", "Cape"], ["Mat", "Mate"], 
            ["Pet", "Pete"], ["Not", "Note"],

            // ğŸŸ  é•·æ¯éŸ³å°æ¯”
            ["Beat", "Bait"], ["Pool", "Pole"], ["Boot", "Boat"], 
            ["Feel", "Fall"], ["Leak", "Lake"], ["Cheap", "Chip"], 
            ["Beet", "Bit"],

            // ğŸ”´ é›™æ¯éŸ³ï¼å…¶ä»–æ¯éŸ³å°æ¯”
            ["Cot", "Caught"], ["Hat", "Hot"], 
            ["Pan", "Pain"], ["Men", "Main"], ["Sell", "Sail"], 
            ["Pull", "Pill"], ["Full", "Fall"], 
            ["Luck", "Look"], ["Cop", "Cup"]
        ];

        const correctPraises = ["Good Job!", "Excellent!", "Awesome!", "Bingo!", "You did it!"];
        const wrongEncouragements = ["Try Again!", "Don't give up!", "Oops!", "Next Time!"];

        let currentTargetWord = null;
        let isSpeaking = false;
        let canAnswer = false; 

        function speakWord(word) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            canAnswer = false;
            speakerIcon.classList.add('speaking');
            speakerIcon.innerText = "ğŸ—£ï¸";

            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.75; 
            utterance.pitch = 1.1; 

            utterance.onend = () => {
                isSpeaking = false;
                canAnswer = true; 
                speakerIcon.classList.remove('speaking');
                speakerIcon.innerText = "ğŸ‘‚";
            };
            window.speechSynthesis.speak(utterance);
        }

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // é‡‘å¹£éŸ³æ•ˆ
        function playCoinSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            const osc1 = audioCtx.createOscillator(); 
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1); gain1.connect(audioCtx.destination);
            osc1.type = 'sine'; osc1.frequency.setValueAtTime(1396.91, t); // F6
            gain1.gain.setValueAtTime(0.1, t); gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
            osc1.start(t); osc1.stop(t + 0.3);

            const osc2 = audioCtx.createOscillator(); 
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2); gain2.connect(audioCtx.destination);
            osc2.type = 'sine'; osc2.frequency.setValueAtTime(1760, t + 0.1); // A6
            gain2.gain.setValueAtTime(0.1, t + 0.1); gain2.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            osc2.start(t + 0.1); osc2.stop(t + 0.5);
        }

        // æº«æŸ”çš„éŒ¯èª¤æç¤ºéŸ³
        function playTryAgainSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(330, t); // E4
            osc.frequency.linearRampToValueAtTime(196, t + 0.4); // G3
            
            gain.gain.setValueAtTime(0.1, t); 
            gain.gain.linearRampToValueAtTime(0, t + 0.4);
            
            osc.start(t); osc.stop(t + 0.4);
        }

        // --- ğŸ¬ ç¹½ç´›ç³–æœç²’å­ ---
        let particles = [];
        const particleColors = ['#FF6B81', '#FFD1DC', '#AEEEEE', '#FFFF99', '#B4F8C8'];
        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.color = particleColors[Math.floor(Math.random() * particleColors.length)];
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 3; 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.02;
                this.size = Math.random() * 8 + 5; 
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.25; // é‡åŠ›
                this.life -= this.decay;
                this.size *= 0.96;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.beginPath();
                ctx.arc(this.x - this.size*0.3, this.y - this.size*0.3, this.size*0.3, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- ğŸ® Qå½ˆæœå‡æ°£æ³¡ ---
        class FlyingBubble {
            constructor(text, startX, colorTheme) {
                this.text = text;
                this.radius = 95; 
                this.x = startX;
                this.y = -this.radius * 2; 
                this.mainColor = colorTheme === 'blue' ? '#87CEEB' : '#FFB6C1'; 
                this.highlightColor = colorTheme === 'blue' ? '#AEEEEE' : '#FFD1DC';
                
                // [ä¿®æ”¹] è®“æ°£æ³¡é£„å¾—æ›´æ…¢ (ç‚ºäº†é…åˆ 12ç§’ æ™‚é–“)
                // é€Ÿåº¦ç¯„åœæ”¹ç‚º 0.5 ~ 1.0ï¼Œé€™æ¨£å¤§ç´„éœ€è¦ 8-12 ç§’æ‰æœƒæ‰å‡ºè¢å¹•
                this.vy = Math.random() * 0.5 + 0.5; 
                
                this.vx = (Math.random() - 0.5) * 0.8; 
                this.pulse = Math.random() * Math.PI;
                this.wobble = Math.random() * Math.PI; 
                this.isHit = false; 
            }

            update() {
                if (this.isHit) return; 
                this.y += this.vy; this.x += this.vx;
                if (this.x < this.radius || this.x > width - this.radius) this.vx *= -1;
                this.pulse += 0.06;
                this.wobble += 0.1;
            }

            draw() {
                if (this.isHit) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                const scaleX = 1 + Math.sin(this.wobble) * 0.05;
                const scaleY = 1 + Math.cos(this.wobble) * 0.05;
                ctx.scale(scaleX, scaleY);

                const currentRadius = this.radius + Math.sin(this.pulse) * 4;

                const grad = ctx.createRadialGradient(0, 0, currentRadius * 0.3, 0, 0, currentRadius);
                grad.addColorStop(0, this.highlightColor);
                grad.addColorStop(0.8, this.mainColor);
                grad.addColorStop(1, 'rgba(255,255,255,0.5)'); 
                
                ctx.shadowBlur = 25; ctx.shadowColor = this.mainColor;
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(0, 0, currentRadius, 0, Math.PI * 2); ctx.fill();
                
                ctx.beginPath();
                ctx.ellipse(-currentRadius*0.3, -currentRadius*0.35, currentRadius*0.25, currentRadius*0.15, Math.PI/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fill();

                ctx.strokeStyle = '#fff'; ctx.lineWidth = 6; ctx.stroke();

                ctx.scale(-1, 1); 
                ctx.fillStyle = '#fff';
                ctx.font = "900 42px 'Fredoka', sans-serif";
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.shadowBlur = 0;
                ctx.lineWidth = 4; ctx.strokeStyle = this.mainColor;
                ctx.strokeText(this.text, 0, 0);
                ctx.fillText(this.text, 0, 0);

                ctx.restore();
            }
            isOffScreen() { return this.y > height + this.radius + 50; }
        }

        let bubbles = [];
        let questionTimer = null;

        function startNewQuestion() {
            if (!gameActive) return;
            const pair = [...wordPairs[Math.floor(Math.random() * wordPairs.length)]];
            currentTargetWord = pair[Math.floor(Math.random() * 2)];
            pair.sort(() => Math.random() - 0.5); 
            bubbles = [];
            bubbles.push(new FlyingBubble(pair[0], width * 0.3, 'blue'));
            bubbles.push(new FlyingBubble(pair[1], width * 0.7, 'pink'));
            setTimeout(() => { speakWord(currentTargetWord); }, 800);
            
            clearTimeout(questionTimer);
            // [ä¿®æ”¹] å°‡æ™‚é–“æ”¹ç‚º 12000 æ¯«ç§’ (12ç§’)
            questionTimer = setTimeout(checkMissed, 12000); 
        }

        function checkMissed() {
            if (bubbles.length > 0 && gameActive) {
                streak = 0; updateUI();
                showFeedback("Try Again!", width/2, height/2, '#aaa');
                playTryAgainSound();
                bubbles = []; setTimeout(startNewQuestion, 1500);
            }
        }

        function handleHit(bubble, handX, handY) {
            if (!canAnswer || bubble.isHit) return;
            bubble.isHit = true; 
            if (bubble.text === currentTargetWord) {
                createExplosion(handX, handY); 
                score += 10; streak++;
                playCoinSound(); 
                const praise = correctPraises[Math.floor(Math.random() * correctPraises.length)];
                showFeedback(praise, handX, handY, '#FFD700'); 
                clearTimeout(questionTimer);
                setTimeout(() => { bubbles = []; setTimeout(startNewQuestion, 1000); }, 500);
            } else {
                createExplosion(handX, handY);
                streak = 0;
                playTryAgainSound(); 
                const encourage = wrongEncouragements[Math.floor(Math.random() * wrongEncouragements.length)];
                showFeedback(encourage, handX, handY, '#FF6B81');
            }
            updateUI();
        }

        function createExplosion(x, y) {
            for(let i=0; i<35; i++) particles.push(new Particle(x, y));
        }
        
        let feedbackText = null;
        function showFeedback(text, x, y, color) {
            feedbackText = { x, y, text, color, life: 1.5, scale: 0.5, rotation: (Math.random()-0.5)*0.4 };
        }

        function updateUI() {
            scoreDisplay.innerText = `Coins: ${score}`;
            streakDisplay.innerText = `Streak: ${streak}`;
        }

        function renderLoop() {
            ctx.clearRect(0, 0, width, height);
            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i]; b.update(); b.draw();
                if (b.isOffScreen() && !b.isHit) bubbles.splice(i, 1);
            }
            if (bubbles.length === 0 && canAnswer && gameActive) { clearTimeout(questionTimer); checkMissed(); }
            particles.forEach((p, idx) => { p.update(); p.draw(); if (p.life <= 0) particles.splice(idx, 1); });

            if (feedbackText) {
                ctx.save();
                ctx.translate(feedbackText.x, feedbackText.y);
                ctx.scale(-feedbackText.scale, feedbackText.scale); 
                ctx.rotate(feedbackText.rotation); 
                feedbackText.y -= 2.5; feedbackText.life -= 0.015;
                feedbackText.scale = Math.min(1.3, feedbackText.scale + 0.1); 
                ctx.globalAlpha = Math.max(0, feedbackText.life);
                ctx.font = "900 50px 'Fredoka', sans-serif"; ctx.textAlign = "center";
                ctx.lineJoin = "round"; ctx.lineWidth = 8; ctx.strokeStyle = "white";
                ctx.strokeText(feedbackText.text, 0, 0);
                ctx.fillStyle = feedbackText.color;
                ctx.fillText(feedbackText.text, 0, 0);
                ctx.restore();
                if (feedbackText.life <= 0) feedbackText = null;
            }
        }

        // --- ğŸŒŸ ç¹ªè£½ã€ŒåŠ å¼·ç‰ˆã€å¯æ„›é­”æ³•æ£’æ¸¸æ¨™ ---
        function drawMagicWand(x, y) {
            ctx.save();
            ctx.translate(x, y);

            // 1. å¼·çƒˆçš„å¤–ç™¼å…‰æ•ˆæœ (Glow)
            ctx.shadowBlur = 35;
            ctx.shadowColor = '#FFD700'; 
            
            // 2. æ£’èº« (åŠ ç²—ã€æ·±ç²‰ç´…)
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(35, 35);
            ctx.lineWidth = 14; 
            ctx.strokeStyle = '#FF6B81'; 
            ctx.lineCap = 'round'; 
            ctx.stroke();

            // 3. æ˜Ÿæ˜Ÿæœ¬é«” (æ”¾å¤§)
            ctx.beginPath();
            const outerRadius = 45; 
            const innerRadius = 22; 
            for (let i = 0; i < 5; i++) {
                ctx.lineTo(Math.cos((18 + i * 72) * Math.PI / 180) * outerRadius, Math.sin((18 + i * 72) * Math.PI / 180) * outerRadius);
                ctx.lineTo(Math.cos((54 + i * 72) * Math.PI / 180) * innerRadius, Math.sin((54 + i * 72) * Math.PI / 180) * innerRadius);
            }
            ctx.closePath();
            
            // é®®è±”çš„å¡«å……èˆ‡é‚Šæ¡†
            ctx.fillStyle = '#FFFF00'; 
            ctx.fill();
            ctx.shadowBlur = 0; 
            ctx.lineWidth = 6; 
            ctx.strokeStyle = '#FF8C00'; 
            ctx.stroke();
            
            // 4. æ˜Ÿæ˜Ÿä¸­é–“çš„å…‰é»
            ctx.beginPath(); ctx.arc(0,0, 12, 0, Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();

            // 5. å‹•æ…‹ç’°ç¹å°å…‰é»
            const time = Date.now() / 300;
            for(let j=0; j<3; j++) {
                const angle = time + (j * (Math.PI * 2 / 3));
                const rx = Math.cos(angle) * 35;
                const ry = Math.sin(angle) * 35;
                ctx.beginPath();
                ctx.arc(rx, ry, 6, 0, Math.PI*2);
                ctx.fillStyle = `rgba(255, 255, 255, ${0.5 + Math.sin(time*2)*0.5})`; 
                ctx.fill();
            }

            ctx.restore();
        }

        function onResults(results) {
            if (!gameActive) return;
            renderLoop(); 
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const indexTip = landmarks[8]; 
                    const x = indexTip.x * width; const y = indexTip.y * height;
                    
                    drawMagicWand(x, y);

                    if (canAnswer) {
                        bubbles.forEach(b => {
                            if (b.isHit) return;
                            const dx = x - b.x; const dy = y - b.y;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            if (dist < b.radius + 30) handleHit(b, x, y);
                        });
                    }
                }
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        startBtn.addEventListener('click', async () => {
            try {
                initAudio();
                const dummy = new SpeechSynthesisUtterance(""); window.speechSynthesis.speak(dummy);
                startBtn.innerText = "Loading..."; startBtn.disabled = true;
                loadingText.innerText = "æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ...è«‹å…è¨±æ¬Šé™";
                width = window.innerWidth; height = window.innerHeight;
                canvasElement.width = width; canvasElement.height = height;
                const camera = new Camera(videoElement, {
                    onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720
                });
                await camera.start();
                startScreen.style.opacity = 0;
                setTimeout(() => { startScreen.style.display = 'none'; }, 500);
                gameActive = true;
                startNewQuestion(); 
            } catch (error) {
                console.error(error);
                loadingText.innerText = "âŒ å•Ÿå‹•å¤±æ•—";
                alert("ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼è«‹ç¢ºèªä½¿ç”¨ HTTPS æˆ– localhostã€‚");
                startBtn.innerText = "PLAY!"; startBtn.disabled = false;
            }
        });

        window.addEventListener('resize', () => {
            width = window.innerWidth; height = window.innerHeight;
            canvasElement.width = width; canvasElement.height = height;
        });
    </script>
</body>
</html>
