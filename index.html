<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phonics Flying: å…’ç«¥ç¾èªè½åŠ›éŠæˆ²</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap');

        body {
            margin: 0;
            background-color: #87CEEB; /* åƒæ˜¯å¤©ç©ºçš„äº®è—è‰²ï¼Œæ›´é©åˆå…’ç«¥ */
            background-image: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            overflow: hidden;
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            user-select: none;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•åˆ·æ–° */
        }
        
        /* éš±è—æ”å½±æ©Ÿå…ƒç´ ä½†ä¿æŒé‹ä½œ */
        #video {
            position: absolute;
            top: 0; left: 0;
            opacity: 0; 
            z-index: -1;
            width: 1px; height: 1px;
            pointer-events: none;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        
        /* åˆ†æ•¸æ¬„æ”¹ç‚ºæ›´å¯æ„›çš„åœ“è§’é¢¨æ ¼ */
        .hud-bar {
            margin-top: 20px;
            background: #FF9800;
            padding: 10px 30px;
            border-radius: 50px;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            gap: 30px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
        }

        .footer-credit {
            margin-bottom: 20px;
            font-size: 16px;
            color: #555;
            font-weight: 700;
            background: rgba(255,255,255,0.6);
            padding: 5px 15px;
            border-radius: 20px;
        }

        #speaker-icon {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0.8;
            transition: 0.2s;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
            z-index: 5;
        }
        .speaking {
            animation: bounce-speaker 0.6s infinite alternate;
            transform: translate(-50%, -50%) scale(1.2);
        }

        @keyframes bounce-speaker {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* é–‹å§‹ç•«é¢ - é‡å°æ‰‹æ©Ÿå„ªåŒ– */
        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #333;
            text-align: center;
        }

        h1 {
            font-size: 50px;
            margin-bottom: 5px;
            color: #FF5E62;
            text-shadow: 2px 2px 0px #FF9966;
        }

        .producer-title {
            font-size: 20px;
            color: #555;
            margin-bottom: 20px;
            font-weight: bold;
            background: #eee;
            padding: 5px 15px;
            border-radius: 10px;
        }

        button {
            margin-top: 20px;
            padding: 20px 60px;
            font-size: 28px;
            font-family: 'Fredoka', sans-serif;
            font-weight: bold;
            background: #4facfe;
            color: white;
            border: 4px solid #fff;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4);
            transition: 0.2s;
            /* è®“æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šå¥½æŒ‰ */
            touch-action: manipulation; 
        }
        button:active {
            transform: scale(0.95);
            background: #00f2fe;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-bar">
            <div id="score-display">Coins: 0</div>
            <div id="streak-display">Streak: 0</div>
        </div>
        
        <div id="speaker-icon">ğŸ”Š</div>

        <div class="footer-credit">å°ç£å…’ç«¥ç¾èªå”æœƒè£½ä½œ</div>
    </div>

    <div id="start-screen">
        <h1>Phonics Flying</h1>
        <div class="producer-title">å°ç£å…’ç«¥ç¾èªå”æœƒè£½ä½œ</div>
        <div style="margin: 20px; color: #666; font-size: 18px; line-height: 1.6;">
            <p>ğŸ§ è«‹æ‰“é–‹è²éŸ³</p>
            <p>ğŸ‘† é»æ“Šé–‹å§‹ï¼Œå…è¨±æ”å½±æ©Ÿæ¬Šé™</p>
            <p>ğŸˆ ç”¨æ‰‹æ“Šç ´æ­£ç¢ºçš„å–®å­—æ°£æ³¡ï¼</p>
        </div>
        <button id="startBtn">PLAY GAME</button>
        <p id="loading-text" style="margin-top: 15px; font-size: 14px; color: #888;">è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹...</p>
    </div>

    <video id="video" playsinline></video>
    <canvas id="output"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output');
        const ctx = canvasElement.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('startBtn');
        const speakerIcon = document.getElementById('speaker-icon');
        const scoreDisplay = document.getElementById('score-display');
        const streakDisplay = document.getElementById('streak-display');
        const loadingText = document.getElementById('loading-text');

        let width, height;
        let gameActive = false;
        let score = 0;
        let streak = 0;
        let audioCtx; // Web Audio API Context

        // --- ğŸ“š å–®å­—åº« (Minimal Pairs - å…©å…©ä¸€çµ„) ---
        const wordPairs = [
            ["Cat", "Cut"],
            ["Pen", "Pan"],
            ["Bad", "Bed"],
            ["Ship", "Sheep"],
            ["Fan", "Van"],
            ["Hat", "Hot"],
            ["Walk", "Work"],
            ["Right", "Light"],
            ["Sing", "Thin"],
            ["Wait", "Wet"]
        ];

        // --- ğŸ† é¼“å‹µè©±èªåº« ---
        const correctPraises = ["Good Job!", "Excellent!", "Awesome!", "Well Done!", "Great!"];
        const wrongEncouragements = ["Try Again!", "Keep Going!", "Don't Give Up!", "Next Time!"];

        let currentTargetWord = null;
        let isSpeaking = false;
        let canAnswer = false; 

        // --- ğŸ”Š èªéŸ³åˆæˆ (TTS) ---
        function speakWord(word) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            canAnswer = false;
            speakerIcon.classList.add('speaking');
            speakerIcon.innerText = "ğŸ—£ï¸"; // æ”¹è®Šåœ–ç¤º

            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.75; // èªé€Ÿé©åˆå…’ç«¥
            utterance.pitch = 1.1;    

            utterance.onend = () => {
                isSpeaking = false;
                canAnswer = true; 
                speakerIcon.classList.remove('speaking');
                speakerIcon.innerText = "ğŸ‘‚"; // æ¢å¾©è†è½åœ–ç¤º
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- ğŸµ éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio API ç”Ÿæˆï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ) ---
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // æ‰‹æ©Ÿç‰ˆä¿®æ­£ï¼šæ’­æ”¾ä¸€å€‹ç„¡è²ç‰‡æ®µä¾†è§£é– Audio Context
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playCoinSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            // ç¬¬ä¸€è² (å®)
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(1200, t); // B5
            gain1.gain.setValueAtTime(0.1, t);
            gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            osc1.start(t);
            osc1.stop(t + 0.5);

            // ç¬¬äºŒè² (éˆ´) - ç¨å¾®å»¶é²
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(1600, t + 0.1); // E6
            gain2.gain.setValueAtTime(0.1, t + 0.1);
            gain2.gain.exponentialRampToValueAtTime(0.01, t + 0.8);
            osc2.start(t + 0.1);
            osc2.stop(t + 0.8);
        }

        function playTryAgainSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            
            // æº«æŸ”çš„ä½éŸ³ (Womp)
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'triangle'; // ä¸‰è§’æ³¢æ¯”è¼ƒæŸ”å’Œ
            osc.frequency.setValueAtTime(300, t); 
            osc.frequency.linearRampToValueAtTime(200, t + 0.3); // éŸ³èª¿ä¸‹é™
            
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.3);
            
            osc.start(t);
            osc.stop(t + 0.3);
        }

        // --- ğŸ’¥ ç²’å­ç³»çµ± ---
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.color = color;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2; 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.05 + 0.02;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.2; // é‡åŠ›
                this.life -= this.decay;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 5, 0, Math.PI*2); // ç²’å­è®Šå¤§ä¸€é»
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- ğŸˆ é£›è¡Œæ°£æ³¡ (FlyingBubble) ---
        class FlyingBubble {
            constructor(text, startX, colorTheme) {
                this.text = text;
                this.radius = 90; // æ°£æ³¡è®Šå¤§ï¼Œæ–¹ä¾¿å…’ç«¥é»æ“Š
                this.x = startX;
                this.y = -this.radius * 2; 
                this.colorTheme = colorTheme; 
                this.color = colorTheme === 'orange' ? '#FF9800' : '#4facfe'; // æ©˜è‰²èˆ‡è—è‰²å°æ¯”
                this.vy = Math.random() * 1.0 + 1.2; // é€Ÿåº¦ç¨æ…¢
                this.vx = (Math.random() - 0.5) * 0.5; 
                this.pulse = Math.random() * Math.PI;
                this.isHit = false; 
            }

            update() {
                if (this.isHit) return; 
                this.y += this.vy;
                this.x += this.vx;
                if (this.x < this.radius || this.x > width - this.radius) this.vx *= -1;
                this.pulse += 0.05;
            }

            draw() {
                if (this.isHit) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                const currentRadius = this.radius + Math.sin(this.pulse) * 3;

                ctx.shadowBlur = 20;
                ctx.shadowColor = this.color;

                // å¡é€šé¢¨æ ¼æ°£æ³¡ (å¯¦è‰² + é«˜å…‰)
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(0, 0, currentRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // ç™½è‰²åå…‰
                ctx.beginPath();
                ctx.arc(-currentRadius*0.3, -currentRadius*0.3, currentRadius*0.2, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fill();

                // ç²—é‚Šæ¡†
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 5;
                ctx.stroke();

                // æ–‡å­—ä¿®æ­£é¡åƒ
                ctx.scale(-1, 1); 
                ctx.fillStyle = 'white';
                ctx.font = "bold 40px 'Fredoka', sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.text, 0, 0);

                ctx.restore();
            }
            
            isOffScreen() {
                return this.y > height + this.radius;
            }
        }

        let bubbles = [];
        let questionTimer = null;

        function startNewQuestion() {
            if (!gameActive) return;
            // éš¨æ©Ÿé¸ä¸€çµ„ (äºŒé¸ä¸€)
            const pair = [...wordPairs[Math.floor(Math.random() * wordPairs.length)]];
            currentTargetWord = pair[Math.floor(Math.random() * 2)];
            pair.sort(() => Math.random() - 0.5); // æ‰“äº‚å·¦å³é †åº

            bubbles = [];
            // ç”Ÿæˆå…©å€‹æ°£æ³¡
            // å·¦é‚Šæ°£æ³¡ (30% å¯¬åº¦è™•), å³é‚Šæ°£æ³¡ (70% å¯¬åº¦è™•)
            bubbles.push(new FlyingBubble(pair[0], width * 0.3, 'blue'));
            bubbles.push(new FlyingBubble(pair[1], width * 0.7, 'orange'));
            
            setTimeout(() => {
                speakWord(currentTargetWord);
            }, 800);

            clearTimeout(questionTimer);
            questionTimer = setTimeout(checkMissed, 7000); 
        }

        function checkMissed() {
            if (bubbles.length > 0 && gameActive) {
                streak = 0;
                updateUI();
                showFeedback("Missed!", width/2, height/2, '#9E9E9E');
                playTryAgainSound();
                bubbles = []; 
                setTimeout(startNewQuestion, 1500);
            }
        }

        function handleHit(bubble, handX, handY) {
            if (!canAnswer || bubble.isHit) return;

            bubble.isHit = true; 

            if (bubble.text === currentTargetWord) {
                // --- ç­”å° ---
                createExplosion(handX, handY, '#FFD700'); // é‡‘è‰²çˆ†ç‚¸
                score += 10; 
                streak++;
                playCoinSound(); // æ’­æ”¾é‡‘å¹£è²
                
                // éš¨æ©Ÿé¸ä¸€å¥é¼“å‹µèª
                const praise = correctPraises[Math.floor(Math.random() * correctPraises.length)];
                showFeedback(praise, handX, handY, '#FFD700'); // é‡‘è‰²æ–‡å­—
                
                clearTimeout(questionTimer);
                setTimeout(() => {
                    bubbles = [];
                    setTimeout(startNewQuestion, 1000);
                }, 500);

            } else {
                // --- ç­”éŒ¯ ---
                createExplosion(handX, handY, '#ccc');
                streak = 0;
                playTryAgainSound(); // æ’­æ”¾æº«æŸ”å¤±æ•—è²
                
                const encourage = wrongEncouragements[Math.floor(Math.random() * wrongEncouragements.length)];
                showFeedback(encourage, handX, handY, '#fff');
            }
            updateUI();
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<30; i++) particles.push(new Particle(x, y, color));
        }
        
        let feedbackText = null;
        function showFeedback(text, x, y, color) {
            feedbackText = { x, y, text, color, life: 1.5, scale: 0.5 };
        }

        function updateUI() {
            scoreDisplay.innerText = `Coins: ${score}`;
            streakDisplay.innerText = `Streak: ${streak}`;
        }

        function renderLoop() {
            ctx.clearRect(0, 0, width, height);
            
            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i];
                b.update();
                b.draw();
                if (b.isOffScreen() && !b.isHit) {
                    bubbles.splice(i, 1);
                }
            }

            if (bubbles.length === 0 && canAnswer && gameActive) {
                 clearTimeout(questionTimer);
                 checkMissed();
            }

            particles.forEach((p, idx) => { p.update(); p.draw(); if (p.life <= 0) particles.splice(idx, 1); });

            if (feedbackText) {
                ctx.save();
                ctx.translate(feedbackText.x, feedbackText.y);
                ctx.scale(-feedbackText.scale, feedbackText.scale); 
                feedbackText.y -= 2; 
                feedbackText.life -= 0.015;
                feedbackText.scale = Math.min(1.2, feedbackText.scale + 0.1); 
                
                ctx.globalAlpha = Math.max(0, feedbackText.life);
                // æ–‡å­—æé‚Šæ•ˆæœ
                ctx.font = "900 45px 'Fredoka', sans-serif";
                ctx.textAlign = "center";
                ctx.lineJoin = "round";
                ctx.lineWidth = 6;
                ctx.strokeStyle = "black";
                ctx.strokeText(feedbackText.text, 0, 0);
                
                ctx.fillStyle = feedbackText.color;
                ctx.fillText(feedbackText.text, 0, 0);
                
                ctx.restore();
                if (feedbackText.life <= 0) feedbackText = null;
            }
        }

        function onResults(results) {
            if (!gameActive) return;
            renderLoop(); 

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const indexTip = landmarks[8]; 
                    const x = indexTip.x * width;
                    const y = indexTip.y * height;

                    // å¯æ„›çš„æ‰‹æŒ‡æ¸¸æ¨™ (æ˜Ÿæ˜Ÿ)
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.beginPath();
                    // ç•«ä¸€å€‹ç°¡å–®çš„åœ“åœˆæ¸¸æ¨™ï¼Œæ¯”è¼ƒä¸æœƒé®æ“‹è¦–ç·š
                    ctx.arc(0, 0, 15, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.fill();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#FF4081';
                    ctx.stroke();
                    ctx.restore();

                    if (canAnswer) {
                        bubbles.forEach(b => {
                            if (b.isHit) return;
                            const dx = x - b.x; const dy = y - b.y;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            if (dist < b.radius + 20) { // å¢åŠ ä¸€é»åˆ¤å®šç¯„åœ
                                handleHit(b, x, y);
                            }
                        });
                    }
                }
            }
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        startBtn.addEventListener('click', async () => {
            try {
                // æ‰‹æ©Ÿè²éŸ³ä¿®å¾©ï¼šå¼·åˆ¶æ’­æ”¾ä¸€æ®µç„¡è²éŸ³è¨Šä¾†è§£é– Context
                initAudio();
                // æ‰‹æ©Ÿè²éŸ³ä¿®å¾©ï¼šå¼·åˆ¶è§¸ç™¼ä¸€æ¬¡ Speech API
                const dummy = new SpeechSynthesisUtterance("");
                window.speechSynthesis.speak(dummy);

                startBtn.innerText = "Loading..."; 
                loadingText.innerText = "æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿ...è«‹é»æ“Šã€Œå…è¨±ã€";
                
                width = window.innerWidth; height = window.innerHeight;
                canvasElement.width = width; canvasElement.height = height;

                const camera = new Camera(videoElement, {
                    onFrame: async () => { await hands.send({image: videoElement}); },
                    width: 1280, height: 720
                });
                
                await camera.start();
                
                startScreen.style.opacity = 0;
                setTimeout(() => { startScreen.style.display = 'none'; }, 500);
                gameActive = true;
                startNewQuestion(); 
            } catch (error) {
                console.error(error);
                loadingText.innerText = "âŒ å•Ÿå‹•å¤±æ•—";
                alert("ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼è«‹ç¢ºèªä½¿ç”¨ HTTPS æˆ– localhostã€‚");
            }
        });

        window.addEventListener('resize', () => {
            width = window.innerWidth; height = window.innerHeight;
            canvasElement.width = width; canvasElement.height = height;
        });
    </script>
</body>
</html>
