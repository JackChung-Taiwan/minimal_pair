<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phonics Flying: è½éŸ³é«”æ„Ÿå°„æ“Š</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap');

        body {
            margin: 0;
            background-color: #1a1a2e;
            /* èƒŒæ™¯æ”¹æˆå‹•æ…‹æ„Ÿçš„æ˜Ÿç©ºæ¼¸å±¤ */
            background-image: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            overflow: hidden;
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            user-select: none;
        }
        canvas {
            position: absolute;
            top: 0; left: 0;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        
        .hud-bar {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 30px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 40px;
            color: white;
            font-size: 24px;
            z-index: 10;
        }

        .footer-credit {
            margin-bottom: 20px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        #speaker-icon {
            position: absolute;
            top: 15%; /* ç§»åˆ°ä¸Šæ–¹æ¯”è¼ƒä¸æœƒæ“‹ä½æ‰è½çš„æ°£æ³¡ */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0.5;
            transition: 0.2s;
            text-shadow: 0 0 20px #fff;
            z-index: 5;
        }
        .speaking {
            animation: pulse-speaker 0.5s infinite alternate;
            color: #00ffcc;
            opacity: 1 !important;
        }

        @keyframes pulse-speaker {
            from { transform: translate(-50%, -50%) scale(1); text-shadow: 0 0 10px #00ffcc; }
            to { transform: translate(-50%, -50%) scale(1.2); text-shadow: 0 0 30px #00ffcc; }
        }

        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(26, 26, 46, 0.95);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        h1 {
            font-size: 60px;
            margin-bottom: 5px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(0, 242, 254, 0.3);
        }

        .producer-title {
            font-size: 24px;
            color: #ddd;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        button {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 24px;
            font-family: 'Fredoka', sans-serif;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
            transition: 0.2s;
        }
        button:hover {
            transform: scale(1.05);
            background: #00f2fe;
        }

        video { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-bar">
            <div id="score-display">Score: 0</div>
            <div id="streak-display">Streak: 0</div>
        </div>
        
        <div id="speaker-icon">ğŸ”Š</div>

        <div class="footer-credit">å°ç£å…’ç«¥ç¾èªå”æœƒè£½ä½œ</div>
    </div>

    <div id="start-screen">
        <h1>Phonics Flying</h1>
        <div class="producer-title">å°ç£å…’ç«¥ç¾èªå”æœƒè£½ä½œ</div>
        <div style="margin: 20px; text-align: center; color: #aaa; font-size: 18px;">
            <p>ğŸ‘‚ ä»”ç´°è½ç™¼éŸ³</p>
            <p>ğŸˆ æ“Šç ´æ­£ç¢ºçš„é£›å¤©æ°£æ³¡</p>
            <p>âš¡ é€Ÿåº¦è¦å¿«ï¼Œæ°£æ³¡æœƒæ‰å…‰å–”ï¼</p>
        </div>
        <button id="startBtn">Start Game</button>
        <p id="loading-text" style="margin-top: 15px; font-size: 14px; color: #666;">Waiting for camera...</p>
    </div>

    <video id="video" playsinline></video>
    <canvas id="output"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output');
        const ctx = canvasElement.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('startBtn');
        const speakerIcon = document.getElementById('speaker-icon');
        const scoreDisplay = document.getElementById('score-display');
        const streakDisplay = document.getElementById('streak-display');

        let width, height;
        let gameActive = false;
        let score = 0;
        let streak = 0;
        
        // --- ğŸ“š å–®å­—åº« (Minimal Pair Triplets - ä¸‰é¸ä¸€) ---
        // é€™äº›å­—çµ„ç™¼éŸ³å¾ˆåƒï¼ŒæŒ‘æˆ°æ€§æ›´é«˜
        const wordTriplets = [
            ["Cat", "Cut", "Cot"],      // Ã¦, ÊŒ, É’
            ["Pen", "Pan", "Pin"],      // e, Ã¦, Éª
            ["Bad", "Bed", "Bud"],      // Ã¦, e, ÊŒ
            ["Sit", "Seat", "Set"],     // Éª, iË, e
            ["Look", "Luke", "Luck"],   // ÊŠ, uË, ÊŒ
            ["Hat", "Hot", "Hut"],      // Ã¦, É’, ÊŒ
            ["Fan", "Van", "Than"],     // f, v, Ã°
            ["Ship", "Sheep", "Chip"],  // Êƒ, iË, tÊƒ
            ["Wait", "Wet", "White"],   // eÉª, e, aÉª
            ["Tail", "Tall", "Tell"]    // eÉª, É”Ë, e
        ];

        let currentTargetWord = null;
        let isSpeaking = false;
        let canAnswer = false; // æ˜¯å¦å…è¨±ä½œç­” (é¿å…è²éŸ³é‚„æ²’å‡ºä¾†å°±äº‚é»)

        // --- ğŸ”Š èªéŸ³åˆæˆ ---
        function speakWord(word) {
            window.speechSynthesis.cancel();
            isSpeaking = true;
            canAnswer = false;
            speakerIcon.classList.add('speaking');

            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.8;     
            utterance.pitch = 1.1;    

            utterance.onend = () => {
                isSpeaking = false;
                canAnswer = true; // è²éŸ³æ’­å®Œæ‰å…è¨±ä½œç­”
                speakerIcon.classList.remove('speaking');
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- ğŸ’¥ ç²’å­ç³»çµ± ---
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.color = color;
                const angle = Math.random() * Math.PI * 2;
                // ç²’å­é€Ÿåº¦åŠ å¿«ä¸€é»ï¼Œå¢åŠ æ‰“æ“Šæ„Ÿ
                const speed = Math.random() * 8 + 4; 
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.02;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.1; // åŠ å…¥ä¸€é»é‡åŠ›
                this.life -= this.decay;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- ğŸˆ é£›è¡Œæ°£æ³¡é¡åˆ¥ (FlyingBubble) ---
        class FlyingBubble {
            constructor(text, startX, colorTheme) {
                this.text = text;
                this.radius = 70; // æ°£æ³¡ç¨å¾®å°ä¸€é»
                this.x = startX;
                this.y = -this.radius * 2; // å¾è¢å¹•ä¸Šæ–¹å¤–é¢é–‹å§‹
                
                // éš¨æ©Ÿé¡è‰²ä¸»é¡Œ (è®“ç•«é¢ç¹½ç´›ä¸€é»)
                this.colorTheme = colorTheme; 
                this.color = colorTheme === 'blue' ? '#4facfe' : (colorTheme === 'pink' ? '#fe4f8a' : '#a64ffe');

                // ä¸‹è½é€Ÿåº¦
                this.vy = Math.random() * 1.5 + 1.5; 
                // æ°´å¹³æ¼‚ç§»
                this.vx = (Math.random() - 0.5) * 1; 

                this.pulse = Math.random() * Math.PI;
                this.isHit = false; // æ¨™è¨˜æ˜¯å¦è¢«æ‰“ä¸­
            }

            update() {
                if (this.isHit) return; // è¢«æ‰“ä¸­å°±åœæ­¢æ›´æ–°(ç­‰å¾…åˆªé™¤)
                this.y += this.vy;
                this.x += this.vx;
                // ç¢°åˆ°å·¦å³é‚Šç•Œåå½ˆ
                if (this.x < this.radius || this.x > width - this.radius) {
                    this.vx *= -1;
                }
                this.pulse += 0.05;
            }

            draw() {
                if (this.isHit) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                const currentRadius = this.radius + Math.sin(this.pulse) * 3;

                // ç™¼å…‰æšˆ
                ctx.shadowBlur = 25;
                ctx.shadowColor = this.color;

                // æ°£æ³¡æœ¬é«” (æ¼¸å±¤æ„Ÿ)
                const grad = ctx.createRadialGradient(0, 0, currentRadius * 0.5, 0, 0, currentRadius);
                grad.addColorStop(0, this.color);
                grad.addColorStop(1, adjustColorBrightness(this.color, -30));
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(0, 0, currentRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // é«˜å…‰
                ctx.beginPath();
                ctx.ellipse(-currentRadius*0.3, -currentRadius*0.3, currentRadius*0.2, currentRadius*0.1, Math.PI/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.fill();

                // é‚Šæ¡†
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();

                // æ–‡å­— (ä¿®æ­£é¡åƒ)
                ctx.scale(-1, 1); 
                ctx.fillStyle = 'white';
                ctx.font = "bold 32px 'Fredoka', sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowBlur = 5;
                ctx.shadowColor = 'black';
                ctx.fillText(this.text, 0, 0);

                ctx.restore();
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰å‡ºè¢å¹•
            isOffScreen() {
                return this.y > height + this.radius;
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šèª¿æ•´é¡è‰²äº®åº¦
        function adjustColorBrightness(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            r = parseInt(r * (100 + percent) / 100);
            g = parseInt(g * (100 + percent) / 100);
            b = parseInt(b * (100 + percent) / 100);
            r = (r<255)?r:255; g = (g<255)?g:255; b = (b<255)?b:255;
            const RR = ((r.toString(16).length==1)?"0"+r.toString(16):r.toString(16));
            const GG = ((g.toString(16).length==1)?"0"+g.toString(16):g.toString(16));
            const BB = ((b.toString(16).length==1)?"0"+b.toString(16):b.toString(16));
            return "#"+RR+GG+BB;
        }

        let bubbles = [];
        let questionTimer = null;

        // --- ğŸ® éŠæˆ²æµç¨‹æ§åˆ¶ ---
        function startNewQuestion() {
            if (!gameActive